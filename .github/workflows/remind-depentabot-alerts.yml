name: Remind Dependabot alerts
on:
  workflow_dispatch:

jobs:
  dependabot-notifier:
    runs-on: ubuntu-latest
    permissions:
      security-events: read
    steps:
      - name: GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_TOKEN }}
        run: |
          gh api \
             -H "Accept: application/vnd.github+json" \
             -H "X-GitHub-Api-Version: 2022-11-28" \
             /repos/mtsuchiya/sample01/dependabot/alerts?state=open \
             --jq \
             'map({
                c: .created_at,
                e: .dependency.package.ecosystem,
                n: .dependency.package.name,
                s: .security_vulnerability.severity
              })
              | unique_by(.s, .e, .n)
              | sort_by(.c)
              | reverse[]
              | "\(.s) on (\(.c)):  \(.e) の \(.n)"
             ' > vuls.txt || true

      - name: cat result
        run: cat vuls.txt
